function MAC(a){if(a instanceof MAC)return void(this.mac=a.mac);if("string"!=typeof a)throw new Error("bad type");var b=a.match(/^([0-9a-fA-F]{2})[-:]([0-9a-fA-F]{2})[-:]([0-9a-fA-F]{2})[-:]([0-9a-fA-F]{2})[-:]([0-9a-fA-F]{2})[-:]([0-9a-fA-F]{2})$/);if("string"==typeof a&&b)return this.mac=b.map(function(a){return parseInt(a,16)}),this.mac=this.mac.slice(1),a;var c=a.match(/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})[:.]([0-9a-fA-F]{2})([0-9a-fA-F]{2})[:.]([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/);if("string"==typeof a&&c)return this.mac=c.map(function(a){return parseInt(a,16)}),this.mac=this.mac.slice(1),a;throw new Error("bad input")}function Connection(){this.connected=[]}function Interface(a,b,c,d){return this.name=a,this.vlan=void 0!==b?b:1,this.isConnect=!1,this.isTrunk=void 0!==c&&c,this.trunkAllowedVlan=void 0!==d?d:new Range(0,4095),this}function Layer2Device(a,b){this.interfaces=a;for(var c=0;c<this.interfaces.length;c++)this.interfaces[c].device=this;return this.macAddrTable=[],b&&(this.receiveCallback=b),this}function IPv4(a){this.set(a)}function Route(a,b,c,d,e,f){this.type=a,this.net=new IPv4(b),this.mask=new IPv4(c),this.nextHop=d,this.portName=e,this.distance=void 0!==f?f:0}function Layer3Device(a,b,c){return Layer2Device.call(this,a,b),this.arp=[],this.route=[],this.sequence=0,this.tcp={},"function"==typeof b&&(this.receiveCallBack=b),"function"==typeof c&&(this.tcpReceiveCallback=c),this}function isInteger(a){return Math.round(a)===a}function clone(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function Range(a,b){return isInteger(a)&&isInteger(b)?(this.begin=a,void(this.end=b)):null}!function(){MAC.prototype.str=function(){return("0"+this.mac[0].toString(16)).slice(-2)+":"+("0"+this.mac[1].toString(16)).slice(-2)+":"+("0"+this.mac[2].toString(16)).slice(-2)+":"+("0"+this.mac[3].toString(16)).slice(-2)+":"+("0"+this.mac[4].toString(16)).slice(-2)+":"+("0"+this.mac[5].toString(16)).slice(-2)},MAC.prototype.equal=function(a){for(var b=new MAC(a),c=0;c<b.mac.length;c++)if(this.mac[c]!==b.mac[c])return!1;return!0}}(),function(){Connection.prototype.connect=function(a){if(!(a instanceof Interface))throw new Error("bad type");if(this.connected.length>2)throw new Error("too many connection");this.connected.push(a)},Connection.prototype.disconnect=function(a){if(!(a instanceof Interface))throw new Error("bad type");for(var b in this.connected)this.connected[b]===a&&this.connected.splice(b,1)},Connection.prototype.connected=function(){return this.connected},Connection.prototype.transfer=function(a,b){var c=this.otherSide(a);if(null==c)throw new Error("connection not established : "+e);return c.device.receive(c,b)},Connection.prototype.otherSide=function(a){return a===this.connected[0]?this.connected[1]:this.connected[0]}}(),function(){Interface.prototype.connect=function(a){if(this.isConnect)throw new Error("interface already connected");return this.connection||(this.connection=new Connection),this.connection.connect(a),a.connection=this.connection,a.connection.connect(this),this.isConnect=!0,a.isConnect=!0,!0},Interface.prototype.disconnect=function(a){if(!this.connection)throw new Error("call disconnect(), but IF is null");return this.connection.disconnect(a),a.connection.disconenct(this),this.connection=null,this.isConnect=!1,!0},Interface.prototype.getConnection=function(){return this.connection},Interface.prototype.transfer=function(a){if(this.isConnect)return this.connection.transfer(this,a)},Interface.prototype.setTrunk=function(a){this.isTrunk=a}}(),function(){Layer2Device.prototype.receive=function(a,b){if(this.receiveCallback)return this.receiveCallback(a,b);var c=a.getConnection().otherSide(a);return this.transfer(c,new MAC(b.sourceMACAddress),new MAC(b.destinationMACAddress),b)},Layer2Device.prototype.transfer=function(a,b,c,d){if(this._addMacTable(a.name,b),c.equal("ff-ff-ff-ff-ff-ff"))return this._sendBroadcast(a,this.interfaces,d);var e=this._searchPort(c);return e.length&&(d=this._processVlan(a,e[0],d))?e[0].transfer(d):this._sendBroadcast(a,this.interfaces,d)},Layer2Device.prototype.setMAC=function(a){if(!(a instanceof Array))return this;for(var b=0;b<a.length;b++)this.getInterface(a[b][0]).mac=new MAC(a[b][1]);return this},Layer2Device.prototype.connect=function(a,b){if(!(b instanceof Interface))throw new Error("bad connect");this.getInterface(a).connect(b)},Layer2Device.prototype.disconnect=function(a,b){if(!(b instanceof Interface))throw new Error("bad connect");this.getInterface(a).disconnect(b)},Layer2Device.prototype.getInterface=function(a){for(var b=0;b<this.interfaces.length;b++)if(a===this.interfaces[b].name)return this.interfaces[b]},Layer2Device.prototype.send=function(a,b,c,d){if("string"!=typeof a)throw new Error("bad type");if(!(d instanceof MAC||void 0===d))throw new Error("bad type");if(!(b instanceof MAC))throw new Error("bad type");void 0===d&&(d=this.getInterface(a).mac);for(var e={sourceMACAddress:d.str(),destinationMACAddress:b.str(),data:c},f=0;f<this.interfaces.length;f++)if(a===this.interfaces[f].name)return this.interfaces[f].getConnection().transfer(this.interfaces[f],e)},Layer2Device.prototype._addMacTable=function(a,b){for(var c=new MAC(b),d=0;d<this.macAddrTable.length;d++)if(c.equal(this.macAddrTable[d][1]))return void(this.macAddrTable[d]=[a,c]);this.macAddrTable.push([a,c])},Layer2Device.prototype._delMacTable=function(a,b){for(var c=new MAC(b),d=0;d<this.macAddrTable.length;d++)a===this.macAddrTable[d][0]&&c.equal(this.macAddrTable[d][1])&&this.macAddrTable.splice(d,1)},Layer2Device.prototype._cacheMacAddr=function(a,b){this.macAddrTable.push([a,b]),this.macAddrTable.sort(function(a,b){return a[0]<b[0]})},Layer2Device.prototype._sendBroadcast=function(a,b,c){for(var d=0;d<b.length;d++)if(a.name!==b[d].name){var e=this._processVlan(a,b[d],c);if(e)return b[d].transfer(e)}},Layer2Device.prototype._processVlan=function(a,b,c){var d;if(a.isTrunk)if(b.isTrunk){if(d=b.trunkAllowedVlan instanceof Range?b.trunkAllowedVlan.array():b.trunkAllowedVlan,d.indexOf(c.vid)<0)return}else{if(c.vid!==b.vlan)return;delete c.vid}else if(b.isTrunk){if(d=b.trunkAllowedVlan instanceof Range?b.trunkAllowedVlan.array():b.trunkAllowedVlan,d.indexOf(a.vlan)<0)return;c.vid=a.vlan}else if(a.vlan!==b.vlan)return;return c},Layer2Device.prototype._searchPort=function(a){for(var b=[],c=[],d=new MAC(a),e=0;e<this.macAddrTable.length;e++)d.equal(this.macAddrTable[e][1])&&b.push(this.macAddrTable[e][0]);if(b.length)for(var e=0;e<b.length;e++)c.push(this.getInterface(b[e]));return c}}(),function(){IPv4.isValid=function(a){var b=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;return!!a.match(b)},IPv4.prototype.set=function(a){try{if(null==a)return void(this.octet=[null,null,null,null]);if("number"==typeof a)return a>>>=0,void(this.octet=[(a&255<<24)>>>24,(a&255<<16)>>>16,(65280&a)>>>8,255&a]);if(a instanceof IPv4)return void(this.octet=a.octet);var b=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;if(!a.match(b))throw new Error("bad address.: "+a);this.octet=b.exec(a).slice(1).map(function(a){return parseInt(a)});for(var c in this.octet)if(this.octet[c]<0||255<this.octet[c])throw new Error("Invalid ip range.: "+a);return}catch(a){console.log(a)}},IPv4.prototype.str=function(){return this.octet[0]+"."+this.octet[1]+"."+this.octet[2]+"."+this.octet[3]},IPv4.prototype.uint=function(){return(this.octet[0]<<24)+(this.octet[1]<<16)+(this.octet[2]<<8)+this.octet[3]>>>0},IPv4.prototype.networkAddr=function(a){if(!(a instanceof IPv4))throw new Error("bad type");var b=this.uint(),c=a.uint();return new IPv4(b&c)},IPv4.prototype.broadcastAddr=function(a){if(!(a instanceof IPv4))throw new Error("bad type");var b=this.uint(),c=a.uint();return new IPv4((b&c)+~c)},IPv4.prototype.equal=function(a){return this.uint()===new IPv4(a).uint()}}(),Route.prototype.constructor=Route,function(){Layer3Device.prototype=Object.create(Layer2Device.prototype),Layer3Device.prototype.receive=function(a,b){if(a.isSwitchPort)return Layer2Device.prototype.transfer.call(this,a,new MAC(b.sourceMACAddress),new MAC(b.destinationMACAddress),b);if("arp"===b.data.protocol&&"1"===b.data.operation)return this.sendARPResponse(a,b);if("arp"===b.data.protocol&&"2"===b.data.operation)return this.arp.push([a.name,b.data.sourceIPAddress,b.data.sourceMACAddress,"dynamic"]);var c=b.data;if("icmp"===c.data.protocol&&8===c.data.type)return this.sendICMPEchoReply(a,b);if("tcp"===c.data.protocol){if(void 0===this.tcp[c.data.destinationPort]&&(this.tcp[c.data.destinationPort]={}),!c.data.urg&&!c.data.ack&&!c.data.psh&&!c.data.rst&&c.data.syn&&!c.data.fin){if(void 0===this.tcp[c.data.destinationPort].status||"LISTEN"===this.tcp[c.data.destinationPort].status)return this.tcp[c.data.destinationPort].status="SYN_RECEIVED",this.sendTCPAckSyn(a,b);if("ESTABLISHED"===this.tcp[c.data.destinationPort].status)return this.tcpReceiveCallback&&this.tcpReceiveCallback(a,b),this.sendTCPAck(a,b)}if(!c.data.urg&&c.data.ack&&!c.data.psh&&!c.data.rst&&c.data.syn&&!c.data.fin&&"SYN_SENT"===this.tcp[c.data.destinationPort].status)return this.tcp[c.data.destinationPort].status="ESTABLISHED",this.sendTCPAck(a,b);if(!c.data.urg&&c.data.ack&&!c.data.psh&&!c.data.rst&&!c.data.syn&&!c.data.fin&&"SYN_RECEIVED"===this.tcp[c.data.destinationPort].status)return this.tcp[c.data.destinationPort].status="ESTABLISHED",!0}return this.receiveCallBack?this.receiveCallBack(a,b):this.transfer(a,b)},Layer3Device.prototype.transfer=function(a,b){var c=this._refRoutingTable(new IPv4(b.data.destinationIPAddress));if(!c)return!1;var d;IPv4.isValid(c.nextHop)?(d=new IPv4(c.nextHop),this.sendARPRequest(this.getInterface(c.portName),d)):(d=new IPv4(b.data.destinationIPAddress),this.sendARPRequest(this.getInterface(c.nextHop),d));for(var e,f,g=0;g<this.arp.length;g++){var h=this.arp[g];if(d.equal(h[1])){f=h[0],e=new MAC(h[2]);break}}if(!e)return!1;var i={sourceIPAddress:b.data.sourceIPAddress,destinationIPAddress:b.data.destinationIPAddress,data:b.data.data};return Layer2Device.prototype.send.call(this,f,e,i)},Layer3Device.prototype.setIP=function(a){if(!(a instanceof Array))return this;for(var b=0;b<a.length;b++)this.getInterface(a[b][0]).ip=new IPv4(a[b][1]),this.getInterface(a[b][0]).mask=new IPv4(a[b][2]?a[b][2]:"255.255.255.255"),this.getInterface(a[b][0]).isSwitchPort=!1;return this._addDirectConnectionRoute(),this},Layer3Device.prototype.setRoute=function(a){if("object"==typeof a||a instanceof Array){if(a.length>0&&!(a[0]instanceof Route))throw new Error("bad type");Array.prototype.push.apply(this.route,a)}return a instanceof Route&&this.route.push(a),this},Layer3Device.prototype.send=function(a,b,c,d){if("string"!=typeof a)throw new Error("bad type");if(!(d instanceof IPv4||void 0===d))throw new Error("bad type");if(!(b instanceof IPv4))throw new Error("bad type");void 0===d&&(d=this.getInterface(a).ip);var e=this._refRoutingTable(b);if(!e)return!1;var f;f=IPv4.isValid(e.nextHop)?new IPv4(e.nextHop):b;var g;if(this.arp.forEach(function(a){if(f.equal(a[1]))return void(g=new MAC(a[2]))}),!g&&(this.sendARPRequest(this.getInterface(a),f),this.arp.forEach(function(a){if(f.equal(a[1]))return void(g=new MAC(a[2]))}),!g))return!1;var h={sourceIPAddress:d,destinationIPAddress:b,data:c};return Layer2Device.prototype.send.call(this,a,g,h)},Layer3Device.prototype.sendARPRequest=function(a,b){var c={protocol:"arp",operation:"1",sourceIPAddress:a.ip.str(),sourceMACAddress:a.mac.str(),destinationIPAddress:new IPv4(b).str(),destinationMACAddress:"00-00-00-00-00-00"};return Layer2Device.prototype.send.call(this,a.name,new MAC("ff-ff-ff-ff-ff-ff"),c)},Layer3Device.prototype.sendARPResponse=function(a,b){if(!a.ip||!a.ip.equal(b.data.destinationIPAddress))return!1;var c={protocol:"arp",operation:"2",sourceIPAddress:a.ip.str(),sourceMACAddress:a.mac.str(),destinationIPAddress:b.data.sourceIPAddress,destinationMACAddress:b.data.sourceMACAddress};return Layer2Device.prototype.send.call(this,a.name,new MAC(c.destinationMACAddress),c)},Layer3Device.prototype.sendICMPEcho=function(a,b,c){var d={protocol:"icmp",type:8,code:0,checksum:"dummy",identifier:0,sequence:c,data:"abcdefghijklmnopqrstuvwabcdefghi"};return this.send(a,b,d)},Layer3Device.prototype.sendICMPEchoReply=function(a,b){var c={protocol:"icmp",type:0,code:0,checksum:"dummy",identifier:0,sequence:b.data.data.sequence,data:"abcdefghijklmnopqrstuvwabcdefghi"};return this.send(a.name,b.data.sourceIPAddress,c)},Layer3Device.prototype.sendTCP=function(a,b,c,d){if(!this.interfaces)return!1;if(!this.interfaces[0].ip)return!1;if("number"!=typeof b)return!1;if(0>b||65535<b)return!1;if(0>c||65535<c)return!1;var e=this._refRoutingTable(a);if(!e)return!1;var f={protocol:"tcp",sourcePort:b,destinationPort:c,sequence:++this.sequence,acknowledgment:0,urg:!1,ack:!1,psh:!1,rst:!1,syn:!0,fin:!1};this.sequence+=160,this.tcp[b]||(this.tcp[b]={}),this.tcp[b].status="SYN_SENT",this.send(this.interfaces[0].name,a,f)&&(console.log("tcp 3way handshake is done"),f.data=d,this.send(this.interfaces[0].name,a,f))},Layer3Device.prototype.sendTCPAckSyn=function(a,b){this.sequence+=160;var c={protocol:"tcp",sourcePort:b.data.data.destinationPort,destinationPort:b.data.data.sourcePort,sequence:this.sequence+1,acknowledgment:this.sequence+1,urg:!1,ack:!0,psh:!1,rst:!1,syn:!0,fin:!1};return this.send(this.interfaces[0].name,b.data.sourceIPAddress,c)},Layer3Device.prototype.sendTCPAck=function(a,b){this.sequence+=160;var c={protocol:"tcp",sourcePort:b.data.data.destinationPort,destinationPort:b.data.data.sourcePort,sequence:this.sequence+1,acknowledgment:b.data.data.sequence+161,urg:!1,ack:!0,psh:!1,rst:!1,syn:!1,fin:!1};return this.send(this.interfaces[0].name,b.data.sourceIPAddress,c)},Layer3Device.prototype._addDirectConnectionRoute=function(){for(var a=0;a<this.interfaces.length;a++){var b=this.interfaces[a];this.route.push(new Route("direct",b.ip,new IPv4("255.255.255.255"),b.name,b.name,0)),this.route.push(new Route("direct",b.ip.networkAddr(b.mask),b.mask,b.name,b.name,0))}},Layer3Device.prototype._refRoutingTable=function(a){if(!(a instanceof IPv4))throw new Error("bad type");for(var b,c=0,d=0;d<this.route.length;d++){var e=this.route[d];(e.net.uint()&e.mask.uint())===(a.uint()&e.mask.uint())&&c<=e.mask.uint()&&(b=e,c=e.mask.uint())}return b}}(),Layer3Device.prototype.constructor=Layer3Device;